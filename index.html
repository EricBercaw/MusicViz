<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spotify Live Data (PKCE)</title>
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    body { margin: 0; background:#0b0b0f; color:#e6e6e6; }
    header { padding: 16px 20px; display:flex; gap:12px; align-items:center; border-bottom:1px solid #222; }
    button { padding:10px 14px; border-radius:10px; border:0; background:#1db954; color:black; font-weight:700; cursor:pointer; }
    button.secondary { background:#2a2a2a; color:#ddd; }
    main { padding:20px; display:grid; gap:16px; max-width:900px; margin:0 auto; }
    .card { background:#111318; border:1px solid #222; border-radius:14px; padding:16px; }
    .row { display:flex; align-items:center; gap:12px; }
    .art { width:64px; height:64px; border-radius:8px; background:#333; object-fit:cover; }
    code, pre { background:#0f1320; color:#cfd7ff; padding:8px 10px; border-radius:8px; display:block; overflow:auto; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; }
    .meter { height:8px; background:#222; border-radius:999px; overflow:hidden; }
    .meter > div { height:100%; background:#1db954; width:0%; transition: width 0.35s linear; }
    .muted { color:#9aa3b2; }
  </style>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
</head>
<body>
  <header>
    <h3 style="margin:0">Spotify Live Data (PKCE)</h3>
    <button id="btnAuth">Connect to Spotify</button>
    <button id="btnLogout" class="secondary" title="Clear token">Logout</button>
    <span id="whoami" class="muted"></span>
  </header>
  <main>
    <section class="card">
      <h4>Now Playing</h4>
      <div class="row">
        <img id="art" class="art" />
        <div>
          <div id="title" style="font-weight:700">—</div>
          <div id="artist" class="muted">—</div>
          <div id="album" class="muted">—</div>
        </div>
      </div>
      <div style="margin-top:12px" class="mono">
        <span id="position">0:00</span> / <span id="duration">0:00</span>
        <div class="meter" style="margin-top:6px"><div id="progress"></div></div>
      </div>
    </section>

    <section class="card">
      <h4>Audio Features</h4>
      <div class="grid mono">
        <div>tempo: <span id="tempo">—</span></div>
        <div>energy: <span id="energy">—</span></div>
        <div>danceability: <span id="danceability">—</span></div>
        <div>valence: <span id="valence">—</span></div>
        <div>key: <span id="key">—</span></div>
        <div>mode: <span id="mode">—</span></div>
      </div>
    </section>

    <section class="card">
      <h4>Auth / Debug</h4>
      <pre id="raw" class="mono" style="max-height:240px"></pre>
    </section>
  </main>

  <script>
    // ===== CONFIG =====
    const CLIENT_ID = "07f3dda064eb4a6c9226822edd2885b7"; // your Spotify app's Client ID
    const REDIRECT_URI = "https://localhost:3000/callback";   // MUST be saved in Spotify dashboard
    const SCOPES = ["user-read-playback-state", "user-read-currently-playing"]; // add more if needed

    // ===== UTILITIES =====
    const $ = (id) => document.getElementById(id);
    const msToClock = (ms) => {
      if (!ms || ms < 0) return "0:00";
      const s = Math.floor(ms/1000), m = Math.floor(s/60), r = s%60;
      return `${m}:${r.toString().padStart(2,'0')}`;
    };

    // ===== PKCE HELPERS =====
    const generateRandomString = (length) => {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      const bytes = crypto.getRandomValues(new Uint8Array(length));
      return Array.from(bytes, b => chars[b % chars.length]).join("");
    };
    const sha256 = async (plain) => {
      const data = new TextEncoder().encode(plain);
      return await crypto.subtle.digest("SHA-256", data);
    };
    const base64url = (buffer) => {
      const bytes = new Uint8Array(buffer);
      let str = "";
      for (let i = 0; i < bytes.byteLength; i++) str += String.fromCharCode(bytes[i]);
      return btoa(str).replace(/=/g, "").replace(/\+/g, "-").replace(/\//g, "_");
    };

    // ===== AUTH (Authorization Code with PKCE) =====
    async function login(){
      const state = crypto.getRandomValues(new Uint32Array(4)).join("-");
      localStorage.setItem("spotify_state", state);

      const code_verifier = generateRandomString(64);
      localStorage.setItem("spotify_code_verifier", code_verifier);
      const code_challenge = base64url(await sha256(code_verifier));

      const auth = new URL("https://accounts.spotify.com/authorize");
      auth.searchParams.set("client_id", CLIENT_ID);
      auth.searchParams.set("response_type", "code");
      auth.searchParams.set("redirect_uri", REDIRECT_URI);
      auth.searchParams.set("scope", SCOPES.join(" "));
      auth.searchParams.set("state", state);
      auth.searchParams.set("code_challenge_method", "S256");
      auth.searchParams.set("code_challenge", code_challenge);
      auth.searchParams.set("show_dialog", "true");

      console.log("Authorize URL:", auth.toString());
      window.location = auth.toString();
    }

    async function exchangeCodeForToken(code){
      const code_verifier = localStorage.getItem("spotify_code_verifier");
      if (!code_verifier) throw new Error("Missing PKCE code_verifier");

      const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          client_id: CLIENT_ID,
          grant_type: "authorization_code",
          code,
          redirect_uri: REDIRECT_URI,
          code_verifier
        })
      });
      if (!res.ok) throw new Error(`Token exchange failed: ${res.status} ${await res.text()}`);

      const data = await res.json();
      const expires_at = Date.now() + data.expires_in * 1000 - 5000;
      const token = { access_token: data.access_token, token_type: data.token_type, expires_at };
      localStorage.setItem("spotify_token", JSON.stringify(token));
      if (data.refresh_token) localStorage.setItem("spotify_refresh_token", data.refresh_token);

      history.replaceState({}, document.title, "/index.html"); // return to app shell after callback
      return token;
    }

    function getStoredToken(){
      const raw = localStorage.getItem("spotify_token");
      if (!raw) return null;
      const tok = JSON.parse(raw);
      if (Date.now() > tok.expires_at) return null;
      return tok;
    }

    async function ensureToken(){
      const existing = getStoredToken();
      if (existing) return existing;

      const params = new URLSearchParams(window.location.search);
      const err = params.get("error");
      if (err) throw new Error("Spotify auth error: " + err);
      const state = params.get("state");
      if (state && state !== localStorage.getItem("spotify_state")) {
        throw new Error("State mismatch; clear storage and try again.");
      }
      const code = params.get("code");
      if (code) return await exchangeCodeForToken(code);
      return null; // not authenticated yet
    }

    // ===== API CALLS =====
    async function api(path, init={}){
      const tok = await ensureToken();
      if (!tok) throw new Error("Not authenticated");
      const res = await fetch(`https://api.spotify.com/v1${path}`, {
        ...init,
        headers: { ...(init.headers||{}), Authorization: `Bearer ${tok.access_token}` }
      });
      if (res.status === 204) return null;
      if (!res.ok) throw new Error(`Spotify API ${res.status}: ${await res.text()}`);
      return res.json();
    }

    async function me(){
      try {
        const data = await api('/me');
        $("whoami").textContent = `Signed in as ${data.display_name || data.id}`;
      } catch (e) { console.warn(e); }
    }

    let lastTrackId = null, progressMs = 0, durationMs = 0, isPlaying = false, tickHandle = null, pollHandle = null;

    async function fetchNowPlaying(){
      try {
        const np = await api('/me/player/currently-playing');
        $("raw").textContent = JSON.stringify(np, null, 2);
        if (!np || !np.item) return;
        const t = np.item;
        lastTrackId = t.id;
        durationMs = t.duration_ms;
        progressMs = np.progress_ms || 0;
        isPlaying = !!np.is_playing;
        $("title").textContent = t.name || '—';
        $("artist").textContent = (t.artists||[]).map(a=>a.name).join(', ');
        $("album").textContent = t.album?.name || '—';
        $("duration").textContent = msToClock(durationMs);
        $("position").textContent = msToClock(progressMs);
        const img = t.album?.images?.[1]?.url || t.album?.images?.[0]?.url;
        if (img) $("art").src = img;
        $("progress").style.width = `${Math.min(100, (progressMs/durationMs)*100)}%`;
        if (lastTrackId) fetchAudioFeatures(lastTrackId);
      } catch (e) { console.error(e); }
    }

    async function fetchAudioFeatures(trackId){
      try {
        const feat = await api(`/audio-features/${trackId}`);
        $("tempo").textContent = Math.round(feat.tempo);
        $("energy").textContent = feat.energy?.toFixed(2);
        $("danceability").textContent = feat.danceability?.toFixed(2);
        $("valence").textContent = feat.valence?.toFixed(2);
        $("key").textContent = feat.key;
        $("mode").textContent = feat.mode ? 'major' : 'minor';
      } catch (e) { console.warn(e); }
    }

    function startTicker(){
      if (tickHandle) clearInterval(tickHandle);
      tickHandle = setInterval(()=>{
        if (isPlaying) {
          progressMs += 1000;
          $("position").textContent = msToClock(progressMs);
          $("progress").style.width = `${Math.min(100, (progressMs/durationMs)*100)}%`;
        }
      }, 1000);
    }
    function startPolling(){
      if (pollHandle) clearInterval(pollHandle);
      pollHandle = setInterval(fetchNowPlaying, 2000);
    }

    // ===== WIRE UP =====
    $("btnAuth").addEventListener('click', login);
    $("btnLogout").addEventListener('click', ()=>{
      localStorage.removeItem("spotify_token");
      localStorage.removeItem("spotify_state");
      localStorage.removeItem("spotify_code_verifier");
      localStorage.removeItem("spotify_refresh_token");
      location.href = "/index.html";
    });

    (async function init(){
      try {
        const tok = await ensureToken();
        if (tok) {
          await me();
          await fetchNowPlaying();
          startTicker();
          startPolling();
        }
      } catch (e) {
        console.warn(e);
      }
    })();
  </script>
</body>
</html>
